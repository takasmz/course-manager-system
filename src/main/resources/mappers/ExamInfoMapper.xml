<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coursemanager.mapper.ExamInfoMapper">
  <resultMap id="BaseResultMap" type="com.coursemanager.model.ExamInfo">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sun Nov 18 17:20:37 CST 2018.
    -->
    <id column="exam_id" jdbcType="VARCHAR" property="examId" />
    <result column="exam_title" jdbcType="VARCHAR" property="examTitle" />
    <result column="exam_content" jdbcType="VARCHAR" property="examContent" />
    <result column="submit_type" jdbcType="INTEGER" property="submitType" />
    <result column="number" jdbcType="INTEGER" property="number" />
    <result column="identify_type" jdbcType="INTEGER" property="identifyType" />
    <result column="answer" jdbcType="VARCHAR" property="answer" />
    <result column="status" jdbcType="INTEGER" property="status" />
    <result column="course_exam_id" jdbcType="INTEGER" property="courseExamId" />
    <result column="return_type" jdbcType="VARCHAR" property="returnType" />
    <result column="input_parameter_type" jdbcType="VARCHAR" property="inputParameterType" />
    <result column="input_parameter_name" jdbcType="VARCHAR" property="inputParameterName" />
  </resultMap>

  <resultMap id="BaseResultMapDto" type="com.coursemanager.dto.ExamInfoDto" extends="BaseResultMap" >
    <result column="id" jdbcType="INTEGER" property="id" />
    <result column="pid" jdbcType="INTEGER" property="pid" />
    <result column="total" jdbcType="INTEGER" property="total" />
    <result column="finished" jdbcType="INTEGER" property="finished" />
    <result column="name" jdbcType="VARCHAR" property="name" />
    <result column="expire_time" jdbcType="VARCHAR" property="expireTime" />
    <result column="show_answer_time" jdbcType="TIMESTAMP" property="showAnswerTime" />
  </resultMap>

    <select id="queryExamById" parameterType="String" resultMap="BaseResultMapDto">
        SELECT
               ei.exam_id,
               ei.exam_title,
               ei.submit_type,
               ei.answer,
               ei.exam_content,
               ei.identify_type,
               ei.inputs,
               ei.number,
               ei.course_exam_id,
               ei.return_type,
               ei.input_parameter_type,
               ei.input_parameter_name
        FROM exam_info ei
        WHERE ei.exam_id = #{examId}
    </select>

    <select id="queryCourseExamList" parameterType="map" resultMap="BaseResultMapDto">
        SELECT
            cei.id,
            0 pid,
            CONCAT( ci.course_name, '第', cei.exam_number, '次作业' ) name,
            '见下拉框' exam_content,
            -1 submit_type,
            -1 `identify_type`,
            100 number,
            '见下拉框' inputs,
            '见下拉框' answer,
            DATE_FORMAT( cei.expire_time, '%Y-%m-%d %H:%i:%S' ) expire_time,
            cei.show_answer_time,
            (SELECT COUNT(course_exam_id) FROM exam_info WHERE course_exam_id = cei.id) total,
            (SELECT COUNT(DISTINCT exam_id) FROM student_exam_info WHERE exam_id IN(SELECT exam_id FROM exam_info WHERE course_exam_id = cei.id)) finished
        FROM
          course_exam_info cei
        LEFT JOIN course_info ci ON cei.course_id = ci.id
        LEFT JOIN student_course sc ON sc.course_id = cei.course_id
        WHERE
            sc.student_id = #{studentId}
            <if test="courseId != null and courseId != ''">
                AND cei.course_id = #{courseId}
            </if>
        AND cei.`status` = 0
    </select>


  <select id="queryExamList" parameterType="map" resultMap="BaseResultMapDto">
	SELECT
	    ei.exam_id id,
		ei.course_exam_id pid,
		ei.exam_title name,
		ei.exam_content,
		ei.submit_type,
		ei.`identify_type`,
		ei.number,
		ei.inputs,
		ei.answer,
		DATE_FORMAT( cei.expire_time, '%Y-%m-%d %H:%i:%S' ) expire_time,
        '' show_answer_time,
      (SELECT COUNT(1) FROM student_exam_info sei WHERE sei.exam_id = ei.exam_id) finished
	FROM
		exam_info ei
		LEFT JOIN course_exam_info cei ON ei.course_exam_id = cei.id
		LEFT JOIN course_info ci ON cei.course_id = ci.id
		LEFT JOIN student_course sc ON sc.course_id = cei.course_id
	WHERE
		sc.student_id = #{studentId}
		<if test="courseId != null and courseId != ''">
            AND cei.course_id = #{courseId}
        </if>
        AND ei.course_exam_id in
        <foreach collection="courseExamList" index="index" open="(" separator="," close=")" item="item">
            #{item.id}
        </foreach>
		AND ei.`status` = 1
	AND cei.`status` = 0
  </select>

    <select id="getCourseExamList" resultMap="BaseResultMapDto" parameterType="map">
        SELECT
               cei.id,
               0 pid,
               CONCAT( ci.course_name, '第', cei.exam_number, '次作业' ) NAME,
               '见下拉框' exam_content,
               - 1 submit_type,
               - 1 `identify_type`,
               100 number,
               '见下拉框' inputs,
               '见下拉框' answer,
               DATE_FORMAT( cei.expire_time, '%Y-%m-%d %H:%i:%S' ) expire_time
        FROM
             course_exam_info cei
                 LEFT JOIN course_info ci ON cei.course_id = ci.id
        WHERE
                cei.course_id = #{courseId}
          AND cei.`status` = 3
          AND cei.id = #{courseExamId}
        UNION ALL
        SELECT
               ei.exam_id id,
               ei.course_exam_id pid,
               ei.exam_title NAME,
               ei.exam_content,
               ei.submit_type,
               ei.`identify_type`,
               ei.number,
               ei.inputs,
               ei.answer,
               DATE_FORMAT( cei.expire_time, '%Y-%m-%d %H:%i:%S' ) expire_time
        FROM
             exam_info ei
                 LEFT JOIN course_exam_info cei ON ei.course_exam_id = cei.id
                 LEFT JOIN course_info ci ON cei.course_id = ci.id
        WHERE
                cei.course_id = #{courseId}
          AND ei.course_exam_id = #{courseExamId}
          AND ei.`status` = 3
          AND cei.`status` = 3
    </select>
</mapper>